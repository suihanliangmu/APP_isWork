name: Sync Hot.json to GitHub and Gitee

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 8:00-20:00 æ¯å°æ—¶æ‰§è¡Œä¸¤æ¬¡ï¼ˆ0åˆ†å’Œ30åˆ†ï¼‰
    - cron: '0,30 0-12 * * *'
  workflow_dispatch:

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ä»£ç æ£€å‡º
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Python ç¯å¢ƒé…ç½®ï¼ˆæ˜¾å¼æŒ‡å®š 3.x ç‰ˆæœ¬ï¼‰
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'  # ä½¿ç”¨æœ€æ–° 3.8 ç‰ˆæœ¬

    # æ–°å¢ä¾èµ–ç¼“å­˜ï¼ˆä¼˜åŒ–ç‚¹ï¼šå‡å°‘é‡å¤å®‰è£…æ—¶é—´ï¼‰
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 3. ä¾èµ–å®‰è£…ï¼ˆå»ºè®®åç»­æ”¹ç”¨ requirements.txtï¼‰
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4

    # 4. æ‰§è¡Œçˆ¬è™«è„šæœ¬
    - name: Run spider
      run: python spider_plus.py

    # 5. GitHub æäº¤ä¼˜åŒ–ï¼ˆä¼˜åŒ–ç‚¹ï¼šä»…åœ¨æ–‡ä»¶å˜æ›´æ—¶æäº¤ï¼‰
    - name: Commit to GitHub
      run: |
        # é…ç½® Git èº«ä»½ï¼ˆæå‰è®¾ç½®é¿å…åç»­æ“ä½œå¤±è´¥ï¼‰
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ™ºèƒ½æ£€æµ‹æ–‡ä»¶å˜æ›´ï¼ˆä¼˜åŒ–ç‚¹ï¼šé¿å…ç©ºæäº¤ï¼‰
        git add hot.json
        if ! git diff --cached --quiet; then
          git commit -m "Update hot.json (Automated)"
          git push
          echo "âœ… Pushed changes to GitHub"
        else
          echo "ğŸ”„ No changes detected, skip GitHub commit"
        fi

    # 6. Gitee åŒæ­¥å‡†å¤‡ï¼ˆSSH å¯†é’¥é…ç½®ï¼‰
    - name: Configure SSH for Gitee
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.GITEE_PRIVATE_KEY }}

    # 7. Gitee åŒæ­¥ä¼˜åŒ–ï¼ˆä¼˜åŒ–ç‚¹ï¼šåŸå­åŒ–æ“ä½œ + å˜æ›´æ£€æµ‹ï¼‰
    - name: Sync to Gitee
      run: |
        # ä½¿ç”¨ä¸´æ—¶ç›®å½•é¿å…æ±¡æŸ“å·¥ä½œåŒº
        temp_dir=$(mktemp -d)
        
        # å…‹éš†ä»“åº“ï¼ˆä¼˜åŒ–ç‚¹ï¼šé™åˆ¶æ·±åº¦èŠ‚çœæ—¶é—´ï¼‰
        git clone --depth 1 git@gitee.com:aodb/is-work-app.git $temp_dir
        
        # æ–‡ä»¶åŒæ­¥æ“ä½œ
        cp -f hot.json $temp_dir/hot.json
        
        # è¿›å…¥ç›®å½•æ“ä½œ
        cd $temp_dir
        
        # é…ç½®ç‹¬ç«‹ Git èº«ä»½ï¼ˆé¿å…ä¸ GitHub é…ç½®å†²çªï¼‰
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        
        # æ™ºèƒ½æäº¤æ£€æµ‹ï¼ˆä¼˜åŒ–ç‚¹ï¼šé¿å…ç©ºæäº¤ï¼‰
        git add hot.json
        if ! git diff --cached --quiet; then
          git commit -m "Sync hot.json from GitHub (Automated)"
          git push origin master
          echo "âœ… Pushed changes to Gitee"
        else
          echo "ğŸ”„ No changes detected, skip Gitee commit"
        fi
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf $temp_dir
